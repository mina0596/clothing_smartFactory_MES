<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ksmart39.springboot.dao.QualityInsMeasurementValueMapper">


	<resultMap type="QualityBiochemFabricLevelStandard" 	id="QualityBiochemFabricLevelStandardResultMap">
		<result property="rawMaterialCode" 						column="raw_material_code" />
		<result property="qualityInspectionCode" 				column="quality_inspection_code" />
		<result property="minValue" 							column="min_value" />
		<result property="maxValue" 							column="max_value" />
		<result property="measuredLevel" 						column="measured_level" />
		<result property="biochemInspectionStandardRegDate" 	column="biochem_inspection_standard_reg_date" />
		<result property="biochemInspectionStandardUpdateDate" 	column="biochem_inspection_standard_update_date" />
	</resultMap>
	
	<resultMap type="QualityInspectionStandard" 			id="QualityInspectionStandardResultMap">
		<result property="qualityInspectionCode" 				column="quality_inspection_code"/>
		<result property="category" 							column="category"/>
		<result property="minValue" 							column="min_value"/>
		<result property="maxValue" 							column="max_value"/>
		<result property="method" 								column="method"/>
		<result property="standardMeasurementUnit" 				column="standard_measurement_unit"/>
		<result property="standardTolerance" 					column="standard_tolerance"/>
		<result property="requiredInspectionCheck" 				column="required_inspection_check"/>
		<result property="inspectionStandardRegDate" 			column="inspection_standard_reg_date"/>
		<result property="inspectionStandardUpdateDate" 		column="inspection_standard_update_date"/>
	</resultMap>
	
	<resultMap type="QualityInspectionResult" 			id="QualityInspectionResultMap">
		<result property="inspectionResultCode" 				column="inspection_result_code"/>
		<result property="qualityInspectionRequestCode" 		column="quality_inspection_request_code"/>
		<result property="chargeEmployeeCode" 					column="charge_employee_code"/>
		<result property="qualityInspectionCode" 				column="quality_inspection_code"/>
		<result property="inspectionMeasurementNum" 			column="inspection_measurement_num"/>
		<result property="inspectionMeasurementValue" 			column="inspection_measurement_value"/>
		<result property="inspectionMeasurementLevelResult" 	column="inspection_measurement_level_result"/>
		<result property="minTolerance" 						column="min_tolerance"/>
		<result property="maxTolerance" 						column="max_tolerance"/>
		<result property="errorRange" 							column="error_range"/>
		<result property="inspectionPassCheck" 					column="inspection_pass_check"/>
		<result property="inspectionStartDate" 					column="inspection_start_date"/>
		<result property="inspectionDuration" 					column="inspection_duration"/>
		<result property="inspectionEndDate" 					column="inspection_end_date"/>
		<result property="inspectionResultRegDate" 				column="inspection_result_reg_date"/>
		<result property="inspectionResultUpdateDate" 			column="inspection_result_update_date"/>
		<result property="rawMaterialCode" 						column="raw_material_code"/>
	</resultMap>
	
	
	<!-- 품질검사 현황 -->
	<select id="getQualityInspectionStatusNow" resultType="Map" parameterType="Map">
		SELECT
			(select
 				COUNT(*)
			 from
 				inspection_result AS i
 			WHERE
 				i.inspection_measurement_num = '1회차') AS 'progressRate'
			,
			(select
				COUNT(*)
				from
					inspection_final_result AS i
				WHERE 
					i.low_cate_final_pass_check='합격') AS finalPassCount
			,(select
				COUNT(*)
				from
					inspection_final_result AS i
				WHERE 
					i.low_cate_final_pass_check='불합격') AS finalFailCount
			,(SELECT
				COUNT(*)
				FROM
				quality_inspection_request AS q) AS requestCount
			,(SELECT
				COUNT(*)
				FROM
				inspection_final_result AS f) AS finalCompleteCount
			,re.quality_inspection_request_code AS inspectionRequestCode
			,high.high_class_name AS highClassName
			,med.med_class_name AS medClassName
			,low.low_class_name AS lowClassName
			,sub.sub_class_name AS subClassName
			,p.requested_product_code AS requestProductCode
			,pc.detailed_categorized_name AS detailedCateName
			,q.inspection_request_date AS inspectionRequestDate
			,res.category AS inspectionCategory
			,ifnull(group_concat(if(re.inspection_measurement_num='1회차', re.inspection_pass_check, NULL)),'심사중') AS insFirst
			,ifnull(group_concat(if(re.inspection_measurement_num='2회차', re.inspection_pass_check, NULL)),'심사중') AS insSecond
			,ifnull(group_concat(if(re.inspection_measurement_num='3회차', re.inspection_pass_check, NULL)),'심사중') AS insThird	
			,ifnull(group_concat(if(re.inspection_measurement_num='1회차', re.inspection_start_date, NULL)),'시작전') AS insStart
			,ifnull(group_concat(if(re.inspection_measurement_num='3회차', re.inspection_end_date, NULL)),'종료전') AS insEnd
			,IFNULL(ref.low_cate_final_pass_check,'종료전') AS finalPassCheck
			,p.contract_code AS contractCode
		
		FROM
			requested_product_detail AS p
		INNER JOIN
			quality_inspection_request AS q ON p.requested_product_code = q.requested_product_code
		LEFT JOIN
			inspection_result AS re ON q.quality_inspection_request_code = re.quality_inspection_request_code
		LEFT JOIN
			inspection_final_result AS ref ON re.quality_inspection_request_code = ref.quality_inspection_request_code
		INNER JOIN
			inspection_standard AS res ON q.quality_inspection_code = res.quality_inspection_code
		INNER JOIN
			sub_class_inspection_list AS sub ON q.quality_inspection_code = sub.quality_inspection_code
		INNER JOIN
			low_class_inspection_list AS low ON sub.high_med_low_class_code = low.high_med_low_class_code
		INNER JOIN
			medium_class_inspection_list AS med ON low.high_med_class_code = med.high_med_class_code
		INNER JOIN
			high_class_inspection_list AS high ON med.high_class_code = high.high_class_code
		INNER JOIN
			product_code_detail AS pc ON p.product_code = pc.product_code
		INNER JOIN
			client_info AS c ON p.client_code = c.client_code
		WHERE 
			p.contract_code = 'buyerContract002'
		GROUP BY q.quality_inspection_request_code;
	</select>
	
	<!-- 품질검사 측정값 목록 -->
	<select id="getInspectionMeasurementValueList" resultMap="QualityInspectionResultMap">
		SELECT 
			inspection_result_code
			,quality_inspection_request_code
			,charge_employee_code
			,quality_inspection_code
			,raw_material_code
			,inspection_measurement_num
			,inspection_measurement_value
			,inspection_measurement_level_result
			,min_tolerance
			,max_tolerance
			,error_range
			,inspection_pass_check
			,inspection_start_date
			,inspection_duration
			,inspection_end_date
			,inspection_result_reg_date
			,inspection_result_update_date
		FROM 
			inspection_result AS i
		GROUP BY i.quality_inspection_request_code;
	</select>
	
	<!-- 품질검사 측정값 등록 -->
	<insert id="addQualityRawMaterialInspectionResult" parameterType="QualityInspectionResult">
		INSERT INTO inspection_result
			(
			inspection_result_code
			,quality_inspection_request_code
			,charge_employee_code
			,quality_inspection_code
			,raw_material_code
			,inspection_measurement_num
			,inspection_measurement_value
			,inspection_measurement_level_result
			,min_tolerance
			,max_tolerance
			,error_range
			,inspection_pass_check
			,inspection_start_date
			,inspection_duration
			,inspection_end_date
			,inspection_result_reg_date
			,inspection_result_update_date
			)VALUES(
			sf_qualityInspectionResultCode(#{qualityInspectionRequestCode})
			,#{qualityInspectionRequestCode}
			,#{chargeEmployeeCode}
			,#{qualityInspectionCode}
			,#{rawMaterialCode}
			,sf_inspectionMeasurementNum(#{qualityInspectionRequestCode})
			,#{inspectionMeasurementValue}
			,#{inspectionMeasurementLevelResult}
			,#{minTolerance}
			,#{maxTolerance}
			,#{errorRange}
			,#{inspectionPassCheck}
			,#{inspectionStartDate}
			,sf_minuteDuration(#{inspectionStartDate},#{inspectionEndDate})
			,#{inspectionEndDate}
			,NOW()
			,NULL
			);
			
	</insert>
	
	<!-- 품질검사 측정값 기준치 -->
	<select id="getQualityInspectionStandard" parameterType="String" resultMap="QualityInspectionStandardResultMap" >
		SELECT 
			quality_inspection_code
			,category
			,min_value
			,max_value
			,method
			,standard_measurement_unit
			,standard_tolerance
			,required_inspection_check
			,inspection_standard_reg_date
			,inspection_standard_update_date
		FROM
			inspection_standard AS i
		WHERE 
			i.quality_inspection_code = #{qualityInspectionCode};
	</select>
	
	<!-- 품질검사 원부자재 기준치 목록 -->
	<select id="getBiochemFabricLevelStandard" parameterType="QualityInspectionResult" resultMap="QualityBiochemFabricLevelStandardResultMap">
		SELECT 
			raw_material_code
			,quality_inspection_code
			,min_value
			,max_value
			,measured_level
			,biochem_inspection_standard_reg_date
			,biochem_inspection_standard_update_date
		FROM 
			biochem_fabric_level_standard AS b
		WHERE
			b.quality_inspection_code = #{qualityInspectionCode}
			AND
			b.raw_material_code = #{rawMaterialCode};
	</select>
	
	<!-- 품질검사 요청목록 목록 -->
	<select id="searchQualityInspectionRequest" resultType="Map" parameterType="Map">
		SELECT
			q.quality_inspection_request_code
			,q.requested_product_code
			,r.contract_code
			,h.high_class_name
			,md.med_class_name
			,s.quality_inspection_code
			,s.sub_class_name
			,q.raw_material_code
			,m.raw_material_name
			,q.inspection_request_date
			,c.client_name
		FROM
			quality_inspection_request AS q INNER JOIN requested_product_detail AS r ON q.requested_product_code = r.requested_product_code
			INNER JOIN sub_class_inspection_list AS s ON q.quality_inspection_code = s.quality_inspection_code
			INNER JOIN medium_class_inspection_list AS md ON s.high_med_class_code = md.high_med_class_code
			INNER JOIN high_class_inspection_list AS h ON md.high_class_code = h.high_class_code
			LEFT JOIN raw_material_info AS m ON q.raw_material_code = m.raw_material_code
			LEFT JOIN client_info AS c ON r.client_code = c.client_code
			LEFT JOIN inspection_result AS re ON q.quality_inspection_request_code = re.quality_inspection_request_code
		<trim prefix="WHERE" prefixOverrides="AND">
			AND 
			q.quality_inspection_request_code NOT IN 
				( select
					ins.quality_inspection_request_code
					from
					 inspection_result AS ins
					WHERE 
						ins.inspection_measurement_num='3회차')
			<if test="contractCode != null and contractCode != ''.toString()">
				AND	r.contract_code LIKE CONCAT('%', #{contractCode} ,'%')
			</if>
			<if test="requestedProductCode != null and requestedProductCode != ''.toString()">
				AND q.requested_product_code LIKE CONCAT('%', #{requestedProductCode} ,'%')
			</if>
			<if test="inspectionRequestStartDate != null and inspectionRequestStartDate != ''.toString()">
				AND q.inspection_request_date &gt;= DATE(#{inspectionRequestStartDate})
			</if>
			<if test="inspectionRequestEndDate != null and inspectionRequestEndDate != ''.toString()">
				AND	q.inspection_request_date &lt;= DATE(#{inspectionRequestEndDate})
			</if>
			<if test="subClassName != null and subClassName != ''.toString()">
				AND s.sub_class_name LIKE CONCAT('%', #{subClassName} ,'%')
			</if>
			<if test="rawMaterialName != null and rawMaterialName != ''.toString()">
				AND m.raw_material_name LIKE CONCAT('%', #{rawMaterialName} ,'%')
			</if>
			<if test="clientName != null and clientName != ''.toString()">
				AND c.client_name LIKE CONCAT('%', #{clientName} ,'%')
			</if>
				GROUP BY q.quality_inspection_request_code;
		</trim>
	</select>
</mapper>